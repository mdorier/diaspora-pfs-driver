name: Template Post-Processing

on:
  push:
    branches:
      - main

jobs:
  template-setup:
    if: github.repository_owner != 'diaspora-project'  # skip in the template repo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract repository name and variants
        id: names
        run: |
          repo="${GITHUB_REPOSITORY##*/}"
          driver="${repo#diaspora-}"; driver="${driver%-driver}"
          echo "driver=$driver" >> $GITHUB_OUTPUT
          echo "driver_snake_case=$(echo "$repo" | tr '-' '_' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "driver_pascal_case=$(echo "$repo" | sed -E 's/(^|-)([a-zA-Z])/\U\2/g')" >> $GITHUB_OUTPUT
          echo "driver_upper_case=$(echo "$repo" | tr '-' '_' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_OUTPUT

      - name: Rename files and replace placeholders
        run: |
          AAA="${{ steps.names.outputs.driver }}"
          BBB="${{ steps.names.outputs.driver_snake_case }}"
          CCC="${{ steps.names.outputs.driver_pascal_case }}"
          DDD="${{ steps.names.outputs.driver_upper_case }}"

          # Rename files/directories with 'AAA' in their names
          find . -depth -name '*AAA*' | while read path; do
            new_path=$(echo "$path" | sed "s/AAA/$AAA/g")
            mkdir -p "$(dirname "$new_path")"
            git mv "$path" "$new_path"
          done

          # Replace contents
          find . -type f ! -path "./.git/*" -exec sed -i \
            -e "s/AAA/$AAA/g" \
            -e "s/BBB/$BBB/g" \
            -e "s/CCC/$CCC/g" \
            -e "s/DDD/$DDD/g" {} +

          # Remove this workflow file
          rm -f .github/workflows/post-template.yml

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Apply template substitutions" || echo "No changes to commit"
          git push

